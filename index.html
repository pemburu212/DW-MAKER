<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DW Marker (By : BTX)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
      flex: 1;
    }
    #map-footer {
        position: fixed;
        bottom: 0px;
        left: 200px;
        background-color: rgba(255,255,255,0.8);
        padding: 1px 12px;
        font-size: 14px;
        color: #212020;
        /* border-radius: 5px; */
        z-index: 1000;
        font-weight: bold;
        pointer-events: none; /* Agar tidak ganggu klik peta */
      
    }
    body {
        font-family: sans-serif;
        padding: 0px;
        box-sizing: border-box;
        margin: 0;
        height: 100%
    }
    button {
        margin: 5px;
    }
    </style>
    <style>
      .marker-label {
        background: none;
        padding: 2px 4px;
        border: none;
        border-radius: 0;
        font-size: 13px;
        font-family: Arial, sans-serif;
        color: white;
        font-weight: bold;
        white-space: nowrap;

        /* Outline (stroke effect) */
        text-shadow:
          -1px -1px 0 #000,
          1px -1px 0 #000,
          -1px  1px 0 #000,
          1px  1px 0 #000;

        pointer-events: none; /* supaya label tidak mengganggu klik marker */
      }
  </style>
  <style>
    button {
      background-color: #007bff; /* Biru */
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:active {
      background-color: #004080;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .button-container {
      position: fixed;
      top: 0px;
      left: 300px; /* menyesuaikan lebar sidebar */
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;  /* Tombol lebih rapat */
      padding: 10px 15px;
      /* background: #003366; */
      border-radius: 8px;
      /* box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); */
    }
    .button-container button {
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 15px;
      background-color: #d3e6de; /* Biru terang */
      color: rgb(0, 0, 0);
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }

    .button-container button:hover {
      background-color: #0056b3;
    }
  </style>
  <style>
        .custom-file {
          position: relative;
          display: inline-block;
        }

        .custom-file input[type="file"] {
          display: none; /* sembunyikan input asli */
        }

        .custom-file-label {
          display: inline-block;
          background-color: #007BFF;
          color: white;
          padding: 6px 12px;
          cursor: pointer;
          border-radius: 4px;
          font-size: 14px;
        }

        .custom-file-label:hover {
          background-color: #0056b3;
        }

        .file-name {
          margin-left: 10px;
          font-style: italic;
        }
  </style>
  </head>
  <body>  
    <div class="button-container">
      <div class="custom-file">
        <label class="custom-file-label" for="kmlInput">Open File</label>
        <input type="file" id="kmlInput" accept=".kml" />
        <span class="file-name" id="fileName">----</span>
      </div>
      <button onclick="setBaseMode()">Select FAT/ODC</button>
      <button onclick="setPolygonMode()">Select Coverage</button>
      <button onclick="setPlacemarkMode()">Select HP/HC</button>
      <button onclick="setAreaMode()">Select Area (Polygon)</button>
      <button onclick="generatePaths()">Running</button>
      <button onclick="exportKML()">Export KML</button>
      <button onclick="resetAll()">Reset</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <script>
      let map = L.map('map', {
        maxZoom: 22
      }).setView([-7.0, 110.0], 10);

      L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: 'Google Satellite',
        maxZoom: 22
      }).addTo(map);

      let placemarks = [];
      let polygons = [];
      let basePlacemark = null;
      let selectedTargets = [];
      let mode = null;
      let drawControl;
      let baseGroups = [];

      document.getElementById('kmlInput').addEventListener('change', handleKMLUpload);

      function handleKMLUpload(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const kmlText = e.target.result;
          const parser = new DOMParser();
          const kmlDoc = parser.parseFromString(kmlText, "text/xml");
          parseKML(kmlDoc);
        };
        reader.readAsText(file);
      }

      function parseKML(kmlDoc) {
        const placemarkElements = kmlDoc.getElementsByTagName("Placemark");
        for (let el of placemarkElements) {
          const name = el.getElementsByTagName("name")[0]?.textContent || "Unnamed";
          const coordsEl = el.getElementsByTagName("coordinates")[0];
          if (!coordsEl) continue;

          const coordsText = coordsEl.textContent.trim();
          const coordPairs = coordsText.split(/\s+/);
          if (coordPairs.length === 1) {
            const [lon, lat] = coordPairs[0].split(",").map(Number);
            const { marker, label } = addLabeledMarker(name, lat, lon);
            marker.on('click', (e) => handleClick(e.originalEvent, marker, name, lat, lon));
            placemarks.push({ name, lat, lon, marker, label });
          } else {
            const latlngs = coordPairs.map(pair => {
              const [lon, lat] = pair.split(",").map(Number);
              return [lat, lon];
            });
            const polygon = L.polygon(latlngs, { color: 'green', fillOpacity: 0.3 }).addTo(map);//.bindPopup(name);
            polygon.on('click', () => handlePolygonClick(polygon));
            polygons.push({ name, polygon });
          }
        }
      }

      function setBaseMode() { mode = "base"; removeDraw(); }
      function setPolygonMode() { mode = "polygon"; removeDraw(); }
      function setPlacemarkMode() { mode = "placemark"; removeDraw(); }

      function setAreaMode() {
        mode = "area";
        removeDraw();
        drawControl = new L.Control.Draw({
          draw: {
            polygon: {
              shapeOptions: { color: 'blue', weight: 2 }
            },
            rectangle: false, polyline: false, circle: false, marker: false, circlemarker: false
          },
          edit: false
        });
        map.addControl(drawControl);
      }

      function removeDraw() {
        if (drawControl) {
          map.removeControl(drawControl);
          drawControl = null;
        }
      }

      function handleClick(event, marker, name, lat, lon) {
        if (mode === "base") {
          if (basePlacemark) resetMarkerIcon(basePlacemark.marker);
          basePlacemark = { name, lat, lon, marker };
          marker.setIcon(L.icon({ 
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41] }));
          //marker.bindPopup(`Base: ${name}`).openPopup();
        } else if (mode === "placemark") {
          if (event.shiftKey) {
            const alreadySelected = selectedTargets.find(p => p.lat === lat && p.lon === lon);
            if (!alreadySelected) {
              selectedTargets.push({ name, lat, lon, marker });
              marker.setIcon(L.icon({ 
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41] }));
            }
          } else if (event.ctrlKey) {
            const index = selectedTargets.findIndex(p => p.lat === lat && p.lon === lon);
            if (index !== -1) {
              const selected = selectedTargets[index];
              resetMarkerIcon(selected.marker);
              selectedTargets.splice(index, 1);
            }
          }
        }
      }

      function handlePolygonClick(polygonLayer) {
        if (mode !== "polygon") return;
        placemarks.forEach(p => {
          const point = L.latLng(p.lat, p.lon);
          if (leafletPointInPolygon(point, polygonLayer.getLatLngs()[0])) {
            if (basePlacemark && p.name === basePlacemark.name) return;
            const alreadySelected = selectedTargets.find(t => t.lat === p.lat && t.lon === p.lon);
            if (!alreadySelected) {
              selectedTargets.push({ name: p.name, lat: p.lat, lon: p.lon, marker: p.marker });
              p.marker.setIcon(L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
              }));
            }
          }
        });
      }
      function addLabeledMarker(name, lat, lon) {
        const marker = L.marker([lat, lon]).addTo(map);
        const label = L.marker([lat, lon], {
          icon: L.divIcon({
            className: 'marker-label',
            html: `<div class="marker-label">${name}</div>`,
            iconSize: [100, 20],
            iconAnchor: [20, 70]
          }),
          interactive: false
        }).addTo(map);
        
        return { marker, label };
      }

      map.on(L.Draw.Event.CREATED, function (e) {
        if (mode !== "area") return;
        const layer = e.layer;
        const polygonLatLngs = layer.getLatLngs()[0];
        map.removeLayer(layer);

        placemarks.forEach(p => {
          const point = L.latLng(p.lat, p.lon);
          if (basePlacemark && p.name === basePlacemark.name) return;
          if (leafletPointInPolygon(point, polygonLatLngs)) {
            const alreadySelected = selectedTargets.find(t => t.lat === p.lat && t.lon === p.lon);
            if (!alreadySelected) {
              selectedTargets.push({ name: p.name, lat: p.lat, lon: p.lon, marker: p.marker });
              p.marker.setIcon(L.icon({
                iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-orange.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
              }));
            }
          }
        });

        removeDraw();
      });

      function leafletPointInPolygon(point, polygonLatLngs) {
        let x = point.lat, y = point.lng;
        let inside = false;
        for (let i = 0, j = polygonLatLngs.length - 1; i < polygonLatLngs.length; j = i++) {
          let xi = polygonLatLngs[i].lat, yi = polygonLatLngs[i].lng;
          let xj = polygonLatLngs[j].lat, yj = polygonLatLngs[j].lng;

          let intersect = ((yi > y) !== (yj > y)) &&
            (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
          if (intersect) inside = !inside;
        }
        return inside;
      }

      function generatePaths() {
        if (!basePlacemark || selectedTargets.length === 0) {
          alert("Pilih base dan target terlebih dahulu.");
          return;
        }

        baseGroups.push({
          base: basePlacemark,
          targets: [...selectedTargets]
        });

        selectedTargets.forEach(target => {
          L.polyline([[basePlacemark.lat, basePlacemark.lon], [target.lat, target.lon]], { color: 'magenta', weight: 1 }).addTo(map);
          resetMarkerIcon(target.marker);
          resetMarkerIcon(basePlacemark.marker);
        });

        basePlacemark = null;
        selectedTargets = [];
      }
      function escapeXML(str) {
          return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');
        }
      function exportKML() {
        if (baseGroups.length === 0) {
          alert("Belum ada path yang dihasilkan.");
          return;
        }

        let folderBlocks = "";

        baseGroups.forEach(group => {
          let folderContent = "";
          group.targets.forEach((target, i) => {
            folderContent += `
            <Placemark>
              <name>DW: ${escapeXML(group.base.name)} -> ${escapeXML(target.name)}</name>
              <LineString>
                <coordinates>
                  ${group.base.lon},${group.base.lat},0
                  ${target.lon},${target.lat},0
                </coordinates>
              </LineString>
            </Placemark>`;
          });

          folderBlocks += `
          <Folder>
            <name>${group.base.name}</name>
            ${folderContent}
          </Folder>`;
        });

        const kml = `<?xml version="1.0" encoding="UTF-8"?>
        <kml xmlns="http://www.opengis.net/kml/2.2">
          <Document>
            ${folderBlocks}
          </Document>
        </kml>`;

        const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `BTX_file.kml`;
        link.click();
      }

      function resetMarkerIcon(marker) {
        marker.setIcon(new L.Icon.Default());
      }

      function resetAll() {
        basePlacemark = null;
        selectedTargets.forEach(p => {
          resetMarkerIcon(p.marker);
          //if (p.label) map.removeLayer(p.label); // hapus label juga
        });
        selectedTargets = [];

        placemarks.forEach(p => {
          resetMarkerIcon(p.marker);
          //if (p.label) map.removeLayer(p.label); // hapus label juga
        });

        map.eachLayer(layer => {
          if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
            map.removeLayer(layer);
          }
        });
      }
    </script>
  </body>
</html>
